# test_b24_api
## Описание проекта:
Тестовое задание ForSales. Управление системой Bitrix24 средствами REST API. Взаимодействие с с истемой Bitrix24 организовано с помощью библиотеки fast_bitrix. Проект содержит модули:
### parsing_xml.py
Модуль обновляет курсы валют в системе Bitrix24. Информация о текущих курсах берётся с сайта cbr.ru в формате XML.  Алгоритм работы модуля:
> Получение данных с сайта cbr.ru в формате XML, фомирование словаря, содержащего курсы валют, которые необходимо обновить.  
> Получение списка валют из системы Bitrix24.  
> Проверка наличия валюты в Bitrix24. Если валюта есть в системе - данные о валюте обновляются метедом update, если валюта отсутствует в системе - данные о валюте добавляются методом add.  
### create_deal.py
Модуль принимает информацию о сделке в формате JSON и заносит эту информацию в систему Bitrix24. Исходные данные для работы модуля:  
> Входные данные в формате JSON в соответствии с ТЗ. Поле 'delivery_date' - строка в формате: yyyy-mm-dd:hh:mm.  
> Соответсвие полей для сделки (crm.deal.fields):  
 Запрос | Bitrix24 
--------|---------
 title | TITLE  
 description     | COMMENTS                  
 client          | CONTACT_ID                
 products        | crm.deal.productrows      
 delivery_adress | UF_CRM_DELIVERY_ADDRESS   
 delivery_date   | CLOSEDATE                 
 delivery_code   | UF_CRM_DELIVERY_CODE      
> Пользовательские поля UF_CRM_DELIVERY_ADDRESS и UF_CRM_DELIVERY_CODE уже созданы в системе.  
> Если сделка уже есть в системе и список товаров отличается от списка товаров в запросе, то товары для сделки из обоих списков объединяются.  
* Алгоритм работы модуля:
> Производится проверка данных в запросе. Проверяется наличие необходимых данных в запросе и их тип.  
> Получение из системы клиента по полю 'phone'. Если клиент в системе отсутствует, создаём нового клиента. Фиксируем ID клиента.  
>Получаем из системы сделку по полю 'delivery_code'. Если сделка отсутствует, создаём новую. Фиксируем данные сделки для дальнейшей работы.  
>Проверяем в сделке поле CLIENT_ID. Если поле не заполнено, записываем в него ID клиента.  
>Проверяем соответсвие полей 'delivery_adress' и 'delivery_date' в запросе и в сделке из Bitrix24. Если поля различаются - записываем в Bitrix24 данные из запроса.  
>Для сделки получаем из Bitrix24 список товаров. Объединяем списки товаров из запроса и Bitrix24 в множество set. Если полученный список отличается от списка в Bitrix24, то обновляем список товаров - добавляем товары к существующему списку.  
### create_userfield.py
Модуль создаёт в Bitrix24 пользовательские поля UF_CRM_DELIVERY_ADDRESS и UF_CRM_DELIVERY_CODE если они отсутствуют.  
### setting.py
В модуле содержатся переменные:
MY_WEBHOOK - вебхук для работы с API Bitrix24
TEST_SERVER_URL - URL мок сервера с тестовым запросом